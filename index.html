<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>今日の3つのいいこと 🌿</title>
<link rel="manifest" href="manifest.json">
<style>
body {
  font-family: "Hiragino Maru Gothic ProN","Yu Gothic",sans-serif;
  background: linear-gradient(180deg,#eef8f3 0%,#ffffff 100%);
  color:#2f3e34;
  text-align:center;
  padding:1rem;
  margin:0;
  overflow-y:auto;
  position:relative;
}

body::before {
  content:"";
  position:fixed;
  top:-50px;
  left:-50px;
  width:120%;
  height:120%;
  background-image:
    radial-gradient(rgba(150,200,150,0.08) 20%,transparent 20%),
    radial-gradient(rgba(130,180,130,0.04) 20%,transparent 20%);
  background-position:0 0,25px 25px;
  background-size:50px 50px;
  z-index:-1;
}


/* 柔らかいタイトル */
h1 {
  color:#356d58;
  font-size:1.8rem;
  margin:1rem 0;
}

/* 入力カード */
.input-card {
  background:#ffffff;
  border-radius:16px;
  padding:1rem;
  box-shadow:0 2px 8px rgba(0,0,0,0.05);
  margin:1rem auto 2rem;
  max-width:400px;
}
.input-card input {
  width:90%;
  max-width:300px;
  padding:0.6rem;
  margin:0.3rem 0;
  border:1px solid #a3c9a8;
  border-radius:10px;
  background-color:#f9fff9;
}
.input-card button {
  background-color:#86cfa3;
  color:white;
  border:none;
  padding:0.6rem 1.2rem;
  border-radius:20px;
  font-size:1rem;
  cursor:pointer;
  margin-top:1rem;
  transition:0.3s;
}
.input-card button:hover {
  background-color:#6cbf90;
  transform:translateY(-2px);
}

/* 履歴カード */
.history-card {
  background:#ffffff;
  border:1px solid #d8e8da;
  border-radius:12px;
  box-shadow:0 1px 6px rgba(0,0,0,0.08);
  padding:1rem;
  margin:1rem auto;
  max-width:600px;
  text-align:left;
}
.history-card h3 {
  margin:0 0 0.4rem;
  color:#355f4a;
}
.history-card ul {
  list-style:none;
  margin:0;
  padding:0;
}
.history-card li {
  background:#f4faf6;
  margin:0.2rem 0;
  padding:0.4rem 0.6rem;
  border-radius:8px;
  word-break:break-word;
}
.history-card button {
  background-color:#ff9d9d;
  color:white;
  border:none;
  padding:0.4rem 0.8rem;
  border-radius:10px;
  font-size:0.9rem;
  margin-top:0.5rem;
  cursor:pointer;
}
.history-card button:hover { background-color:#f77373; }

/* 削除履歴 */
#deletedSection {
  display:none;
  margin-top:2rem;
}
#toggleDeletedBtn {
  background-color:#a3cfa3;
  color:white;
  border:none;
  padding:0.6rem 1.2rem;
  border-radius:20px;
  font-size:1rem;
  cursor:pointer;
  margin:1rem auto;
  display:block;
}
#toggleDeletedBtn:hover {
  background-color:#8cc790;
}

/* カレンダー */
#calendar {
  margin:2rem auto;
  background-color:#f6fbf7;
  border-radius:12px;
  padding:1rem;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
  max-width:600px;
}
.calendar-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:1rem;
}
.calendar-header button {
  background-color:#a8d5b5;
  border:none;
  padding:0.3rem 0.8rem;
  border-radius:10px;
  cursor:pointer;
}
.calendar-header h3 {
  margin:0;
  color:#2f5d50;
}
.calendar-grid {
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:5px;
}
.calendar-cell {
  padding:0.6rem 0;
  border-radius:8px;
  background-color:#ffffff;
  border:1px solid #d8e8da;
  font-size:0.9rem;
  cursor:pointer;
  position:relative;
}
.calendar-cell.has-entry::after {
  content:"🌸";
  position:absolute;
  bottom:4px;
  right:6px;
  font-size:1rem;
}
.calendar-cell.today {
  background-color:#e8f5ec;
  font-weight:bold;
}

/* 選択日履歴 */
#selectedDayHistory {
  background-color:#f6fbf7;
  border-radius:12px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
  padding:1rem;
  margin:1.5rem auto;
  max-width:600px;
  text-align:left;
}

/* 花アニメーション */
@keyframes floatFlower {
  0% {transform:translateY(0) scale(1);opacity:1;}
  50% {transform:translateY(-40px) scale(1.2);opacity:0.8;}
  100% {transform:translateY(-80px) scale(0.8);opacity:0;}
}
.floating-flower {
  position:absolute;
  font-size:1.5rem;
  pointer-events:none;
  animation:floatFlower 1.2s ease-out forwards;
}
</style>
</head>
<body>
<h1>🌿 今日の3つのいいこと</h1>

<div class="input-card">
  <input id="good1" placeholder="いいこと1"><br>
  <input id="good2" placeholder="いいこと2"><br>
  <input id="good3" placeholder="いいこと3"><br>
  <button onclick="saveGoodThings()">保存</button>
</div>

<h2>📖 今日までの記録</h2>
<div id="history"></div>

<button id="toggleDeletedBtn" onclick="toggleDeleted()">🗂️ 削除した履歴を表示</button>

<div id="deletedSection">
  <h2>🗑️ 削除した履歴（ゴミ箱）</h2>
  <div id="deletedHistory"></div>
</div>

<!-- カレンダー -->
<div id="calendar">
  <div class="calendar-header">
    <button onclick="prevMonth()">←</button>
    <h3 id="calendarTitle"></h3>
    <button onclick="nextMonth()">→</button>
  </div>
  <div class="calendar-grid" id="calendarGrid"></div>
</div>

<div id="selectedDayHistory"></div>

<script>
function saveGoodThings(){
  const timestamp=Date.now();
  const goodThings=[
    document.getElementById('good1').value,
    document.getElementById('good2').value,
    document.getElementById('good3').value
  ];
  localStorage.setItem(timestamp,JSON.stringify(goodThings));
  showHistory();
  renderCalendar();

  document.getElementById('good1').value='';
  document.getElementById('good2').value='';
  document.getElementById('good3').value='';

  const flower=document.createElement('div');
  flower.className='floating-flower';
  flower.textContent='🌸';
  document.body.appendChild(flower);
  const btn=document.querySelector('.input-card button');
  const rect=btn.getBoundingClientRect();
  flower.style.left=rect.left+rect.width/2+'px';
  flower.style.top=rect.top+'px';
  flower.addEventListener('animationend',()=>flower.remove());
}

// 履歴表示（カード型）
function showHistory(){
  const history=document.getElementById('history');
  history.innerHTML='';
  const keys=[];
  for(let i=0;i<localStorage.length;i++){
    const key=localStorage.key(i);
    if(!key.startsWith('deleted_') && !isNaN(Number(key))) keys.push(Number(key));
  }
  keys.sort((a,b)=>b-a);
  keys.forEach(keyNum=>{
    const value=JSON.parse(localStorage.getItem(String(keyNum)));
    const div=document.createElement('div');
    div.className='history-card';
    div.innerHTML=`
      <h3>${new Date(keyNum).toLocaleString()}</h3>
      <ul>
        <li>① ${value[0]||''}</li>
        <li>② ${value[1]||''}</li>
        <li>③ ${value[2]||''}</li>
      </ul>
      <button data-key="${keyNum}">削除</button>
    `;
    history.appendChild(div);
  });

  document.querySelectorAll('.history-card button').forEach(btn=>{
    btn.onclick=e=>{
      const key=e.target.getAttribute('data-key');
      const deletedItem=localStorage.getItem(key);
      localStorage.setItem(`deleted_${key}`,deletedItem);
      localStorage.removeItem(key);
      showHistory();
      showDeletedHistory();
      renderCalendar();
      showSelectedDayHistory();
    };
  });
}

// 削除履歴
function showDeletedHistory(){
  const container=document.getElementById('deletedHistory');
  container.innerHTML='';
  const keys=[];
  for(let i=0;i<localStorage.length;i++){
    const key=localStorage.key(i);
    if(key.startsWith('deleted_')) keys.push(key);
  }
  keys.sort((a,b)=>b.localeCompare(a));
  keys.forEach(key=>{
    const value=JSON.parse(localStorage.getItem(key));
    const div=document.createElement('div');
    div.className='history-card';
    div.innerHTML=`
      <h3>${new Date(Number(key.replace('deleted_',''))).toLocaleString()}</h3>
      <ul>
        <li>① ${value[0]||''}</li>
        <li>② ${value[1]||''}</li>
        <li>③ ${value[2]||''}</li>
      </ul>
    `;
    container.appendChild(div);
  });
}

function toggleDeleted(){
  const section=document.getElementById('deletedSection');
  section.style.display=section.style.display==='none'?'block':'none';
  showDeletedHistory();
}

// カレンダー
let currentMonth=new Date();
function renderCalendar(){
  const year=currentMonth.getFullYear();
  const month=currentMonth.getMonth();
  const firstDay=new Date(year,month,1);
  const lastDay=new Date(year,month+1,0);
  const grid=document.getElementById('calendarGrid');
  grid.innerHTML='';
  document.getElementById('calendarTitle').textContent=`${year}年 ${month+1}月`;

  const startWeek=firstDay.getDay();
  for(let i=0;i<startWeek;i++) grid.appendChild(document.createElement('div'));

  const today=new Date();
  const entries=getEntryDates();

  for(let d=1;d<=lastDay.getDate();d++){
    const cell=document.createElement('div');
    cell.className='calendar-cell';
    const date=new Date(year,month,d);
    cell.textContent=d;

    if(date.toDateString()===today.toDateString()) cell.classList.add('today');
    const dateStr=date.toLocaleDateString();
    if(entries.includes(dateStr)) cell.classList.add('has-entry');

    cell.onclick=()=>showSelectedDayHistory(dateStr);
    grid.appendChild(cell);
  }
}
function getEntryDates(){
  const dates=[];
  for(let i=0;i<localStorage.length;i++){
    const key=localStorage.key(i);
    if(!key.startsWith('deleted_') && !isNaN(Number(key))){
      const d=new Date(Number(key)).toLocaleDateString();
      if(!dates.includes(d)) dates.push(d);
    }
  }
  return dates;
}
function prevMonth(){ currentMonth.setMonth(currentMonth.getMonth()-1); renderCalendar(); }
function nextMonth(){ currentMonth.setMonth(currentMonth.getMonth()+1); renderCalendar(); }

function showSelectedDayHistory(dateStr){
  const container=document.getElementById('selectedDayHistory');
  container.innerHTML=`<h3>${dateStr} の記録</h3>`;
  const keys=[];
  for(let i=0;i<localStorage.length;i++){
    const key=localStorage.key(i);
    if(!key.startsWith('deleted_') && !isNaN(Number(key))){
      const kDate=new Date(Number(key)).toLocaleDateString();
      if(kDate===dateStr) keys.push(Number(key));
    }
  }
  keys.sort((a,b)=>b-a);
  if(keys.length===0){
    container.innerHTML+='<p>記録なし</p>';
    return;
  }
  keys.forEach(k=>{
    const v=JSON.parse(localStorage.getItem(String(k)));
    container.innerHTML+=`
      <div class="history-card">
        <h3>${new Date(k).toLocaleTimeString()}</h3>
        <ul>
          <li>① ${v[0]||''}</li>
          <li>② ${v[1]||''}</li>
          <li>③ ${v[2]||''}</li>
        </ul>
      </div>`;
  });
}

// 通知
function requestNotificationPermission(){
  if("Notification" in window){
    Notification.requestPermission().then(permission=>{
      if(permission==="granted") scheduleDailyNotification();
    });
  }
}
function scheduleDailyNotification(){
  const now=new Date();
  let next21=new Date();
  next21.setHours(21,0,0,0);
  if(now>next21) next21.setDate(next21.getDate()+1);
  const timeout=next21.getTime()-now.getTime();
  setTimeout(()=>{
    showNotification();
    setInterval(showNotification,24*60*60*1000);
  },timeout);
}
function showNotification(){
  if("Notification" in window && Notification.permission==="granted"){
    new Notification("🌸 今日の3つのいいことを記録しよう！",{
      body:"21:00になりました。今日のいいことを書きましょう🌿",
      icon:"kyattorabinngu.png"
    });
  }
}

// 初期表示
showHistory();
renderCalendar();
window.onload=requestNotificationPermission;

if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js").then(()=>console.log("Service Worker 登録完了！"));
}
</script>
</body>
</html>
