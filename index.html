<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>今日の3つのいいこと 🌿</title>

<!-- PWA / iOS meta -->
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#86cfa3">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="3つのいいこと">
<link rel="apple-touch-icon" href="./kyattorabinngu.png">

<style>
/* ------------------- 全体 ------------------- */
body{
  font-family:"Hiragino Maru Gothic ProN","Yu Gothic",sans-serif;
  background:linear-gradient(180deg,#eef8f3 0%,#ffffff 100%);
  color:#2f3e34;
  text-align:center;
  margin:0;padding:1rem;
  overflow-x:hidden;
  position:relative;
}

/* ドット背景（復活） */
body::before {
  content:"";
  position:fixed;
  top:-50px;
  left:-50px;
  width:120%;
  height:120%;
  background-image:
    radial-gradient(rgba(150,200,150,0.08) 20%, transparent 20%),
    radial-gradient(rgba(130,180,130,0.04) 20%, transparent 20%);
  background-position: 0 0, 25px 25px;
  background-size: 50px 50px;
  z-index: -1;
  pointer-events: none;
}

h1{ color:#356d58; font-size:1.8rem; margin:1rem 0; }

/* ------------------- 入力フォーム ------------------- */
.input-card{
  background:#fff;border-radius:16px;padding:1rem;
  box-shadow:0 2px 8px rgba(0,0,0,0.05);
  max-width:400px;margin:1rem auto 2rem;
}
.input-card input,.input-card textarea{
  width:90%;max-width:300px;padding:0.6rem;
  border:1px solid #a3c9a8;border-radius:10px;
  margin:0.3rem 0;background:#f9fff9;font-size:1rem;
}
.input-card textarea{ resize:none;height:60px; }

/* ------------------- ボタン ------------------- */
.btn{
  background-color:#86cfa3;color:white;border:none;
  padding:0.6rem 1.2rem;border-radius:20px;
  font-size:1rem;cursor:pointer;margin:1rem auto;transition:0.3s;
}
.btn:hover{ background-color:#6cbf90; transform:translateY(-2px); }

/* ------------------- カレンダー ------------------- */
#calendar{
  max-width:600px;margin:2rem auto;padding:1rem;
  background:#f6fbf7;border-radius:12px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
  position:relative; z-index:0;
}
.calendar-header{ display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem; }
.calendar-header button{ background:#a8d5b5;border:none;padding:0.3rem 0.8rem;border-radius:10px;cursor:pointer; }
.calendar-grid{ display:grid;grid-template-columns:repeat(7,1fr);gap:5px; }
.calendar-cell{
  padding:0.6rem 0;border-radius:8px;background:#fff;border:1px solid #d8e8da;
  cursor:pointer;position:relative;
}
.calendar-cell.has-entry::after{
  content:"🌸";position:absolute;bottom:4px;right:6px;font-size:1rem;
}
.calendar-weekday-header { font-weight:bold; }
.calendar-weekday-header.sunday { color:#e74c3c; }
.calendar-weekday-header.saturday { color:#3498db; }

/* ------------------- モーダル ------------------- */
.modal{
  display:none;position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0);justify-content:center;align-items:flex-start;
  overflow-y:auto;z-index:1000;transition:background 0.28s ease;
}
.modal.show{ display:flex; }
.modal.show-animate{ background:rgba(0,0,0,0.4); }

/* モーダルコンテンツ：内部スクロール可能にする */
.modal-content{
  background:#fff;border-radius:16px;margin:3rem auto;padding:1rem;
  max-width:520px;width:94%;box-shadow:0 4px 12px rgba(0,0,0,0.2);
  opacity:0; transform:translateY(-28px) scale(0.96);
  transition:opacity 0.36s cubic-bezier(.2,.9,.2,1), transform 0.36s cubic-bezier(.2,.9,.2,1);

  max-height: calc(100vh - 6rem);
  overflow: auto;
  -webkit-overflow-scrolling: touch;
  box-sizing: border-box;
}
.modal.show-animate .modal-content{
  opacity:1; transform:translateY(0) scale(1);
}

/* ------------------- 履歴カード ------------------- */
.history-card{
  background:#fff;border:1px solid #d8e8da;border-radius:12px;
  box-shadow:0 1px 6px rgba(0,0,0,0.08);padding:1rem;margin:0.5rem auto;
  max-width:500px;text-align:left;
}
.history-card h3{ margin:0 0 0.4rem;color:#355f4a; }
.history-card ul{ list-style:none;margin:0;padding:0; }
.history-card li{
  background:#f4faf6;margin:0.2rem 0;padding:0.4rem 0.6rem;border-radius:8px;word-break:break-word;
}
.comment-box{
  margin-top:0.5rem;font-style:italic;color:#4b6653;background:#f9fff9;padding:0.5rem 0.7rem;
  border-left:4px solid #a3cfa3;border-radius:6px;
}
.history-card button{
  background:#ff9d9d;color:white;border:none;padding:0.4rem 0.8rem;border-radius:10px;
  font-size:0.9rem;margin-top:0.5rem;cursor:pointer;
}
.history-card button:hover{ background:#f77373; }

/* ------------------- 日付選択 ------------------- */
#entryDateInput{ margin-bottom:0.5rem;font-size:1rem; }

/* ------------------- 桜 ------------------- */
.sakura{ position:fixed; top:-2rem; pointer-events:none; z-index:2000; animation:sakuraFall 2.5s linear forwards; }
@keyframes sakuraFall{ 0%{ transform:translateY(0) rotate(0deg); opacity:1; } 100%{ transform:translateY(100vh) rotate(360deg); opacity:0; } }

/* レスポンシブ */
@media (max-width:420px){
  .input-card,.modal-content{ padding:0.8rem; }
  .btn{ padding:0.5rem 1rem; }
}
</style>
</head>
<body>

<h1>🍀 今日の3つのいいこと 🍀</h1>

<div class="input-card">
  <input type="date" id="entryDateInput"><br>
  <input id="good1" placeholder="いいこと①"><br>
  <input id="good2" placeholder="いいこと②"><br>
  <input id="good3" placeholder="いいこと③"><br>
  <textarea id="comment" placeholder="今日のひとことメモ"></textarea><br>
  <button class="btn" onclick="saveGoodThings()">保存</button>
</div>

<div id="calendar">
  <div class="calendar-header">
    <button onclick="prevMonth()">←</button>
    <h3 id="calendarTitle"></h3>
    <button onclick="nextMonth()">→</button>
  </div>
  <div class="calendar-grid" id="calendarGrid"></div>
</div>

<button class="btn" onclick="showAllHistory()">📖 すべての履歴を見る</button>

<!-- モーダル -->
<div id="historyModal" class="modal" onclick="closeModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div id="modalNav" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <button id="prevDayBtn" class="btn" style="width:45%;padding:0.5rem;">前日</button>
      <button id="nextDayBtn" class="btn" style="width:45%;padding:0.5rem;">翌日</button>
    </div>
    <h2 id="modalDateTitle">📅</h2>
    <div id="historyList"></div>
  </div>
</div>

<script>
/* ---------- 状態 ---------- */
let selectedDate = new Date();
let modalDate = new Date();
let isShowingAllHistory = false;

/* 保存しておく（ロック用） */
let _lockedScrollY = 0;
let _savedBodyPaddingRight = '';
let _useIosScrollLock = /iP(ad|hone|od)/.test(navigator.platform) || navigator.userAgent.includes('Macintosh') && 'ontouchend' in document;

/* ---------- ヘルパー ---------- */
function formatDate(d){
  const y = d.getFullYear();
  const m = ('0'+(d.getMonth()+1)).slice(-2);
  const day = ('0'+d.getDate()).slice(-2);
  return `${y}-${m}-${day}`;
}

/* ---------- スクロールバー幅取得 ---------- */
function getScrollbarWidth(){
  return window.innerWidth - document.documentElement.clientWidth;
}

/* ---------- BODY スクロールロック（iOS フォールバック含む） ---------- */
function lockBodyScroll(){
  _lockedScrollY = window.scrollY || document.documentElement.scrollTop || 0;

  // スクロールバー幅補正（デスクトップ）
  const sbWidth = getScrollbarWidth();
  if(sbWidth > 0){
    _savedBodyPaddingRight = document.body.style.paddingRight || '';
    const current = parseFloat(getComputedStyle(document.body).paddingRight) || 0;
    document.body.style.paddingRight = (current + sbWidth) + 'px';
  }

  if(_useIosScrollLock){
    // iOS では position:fixed が挙動怪しいので overflow:hidden を使う（body の幅ずれは上の補正で吸収）
    document.documentElement.style.overflow = 'hidden';
    document.body.style.overflow = 'hidden';
  } else {
    // デスクトップでは position:fixed で位置を固定
    document.body.style.position = 'fixed';
    document.body.style.top = `-${_lockedScrollY}px`;
    document.body.style.left = '0';
    document.body.style.right = '0';
  }
}

function unlockBodyScroll(){
  if(_useIosScrollLock){
    document.documentElement.style.overflow = '';
    document.body.style.overflow = '';
  } else {
    document.body.style.position = '';
    document.body.style.top = '';
    document.body.style.left = '';
    document.body.style.right = '';
    window.scrollTo(0, _lockedScrollY);
  }

  // padding-right を元に戻す
  if(_savedBodyPaddingRight !== ''){
    document.body.style.paddingRight = _savedBodyPaddingRight;
  } else {
    document.body.style.paddingRight = '';
  }
  _savedBodyPaddingRight = '';
}

/* ---------- 保存 ---------- */
function saveGoodThings(){
  const key = document.getElementById('entryDateInput').value || formatDate(new Date());
  const data = {
    goodThings:[
      document.getElementById('good1').value,
      document.getElementById('good2').value,
      document.getElementById('good3').value
    ],
    comment: document.getElementById('comment').value
  };
  localStorage.setItem(key, JSON.stringify(data));
  renderCalendar();
  document.getElementById('good1').value='';
  document.getElementById('good2').value='';
  document.getElementById('good3').value='';
  document.getElementById('comment').value='';
  createSakura();
}

/* ---------- カレンダー ---------- */
function renderCalendar(){
  const grid = document.getElementById('calendarGrid');
  grid.innerHTML = '';
  const year = selectedDate.getFullYear();
  const month = selectedDate.getMonth();
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month+1, 0);
  document.getElementById('calendarTitle').textContent = `${year}年 ${month+1}月`;

  const weekdays = ['日','月','火','水','木','金','土'];
  weekdays.forEach((d,i)=>{
    const c = document.createElement('div');
    c.textContent = d;
    c.className = 'calendar-weekday-header';
    if(i===0) c.classList.add('sunday');
    if(i===6) c.classList.add('saturday');
    grid.appendChild(c);
  });

  for(let i=0;i<firstDay.getDay();i++) grid.appendChild(document.createElement('div'));
  for(let d=1; d<=lastDay.getDate(); d++){
    const date = new Date(year, month, d);
    const key = formatDate(date);
    const cell = document.createElement('div');
    cell.className = 'calendar-cell';
    if(localStorage.getItem(key)) cell.classList.add('has-entry');
    cell.textContent = d;
    cell.onclick = ()=> showHistoryModal(date);
    grid.appendChild(cell);
  }
}
function prevMonth(){ selectedDate.setMonth(selectedDate.getMonth()-1); renderCalendar(); }
function nextMonth(){ selectedDate.setMonth(selectedDate.getMonth()+1); renderCalendar(); }

/* ---------- モーダル表示 ---------- */
function showHistoryModal(date){
  modalDate = new Date(date);
  isShowingAllHistory = false;
  const modal = document.getElementById('historyModal');
  const list = document.getElementById('historyList');
  const title = document.getElementById('modalDateTitle');
  const key = formatDate(modalDate);

  title.textContent = `📅 ${key}`;
  list.innerHTML = '';
  document.getElementById('modalNav').style.display = 'flex';

  // 安全に JSON.parse する（非JSON 値が混じっていても例外で停止しない）
  const raw = localStorage.getItem(key);
  if(raw){
    try {
      const data = JSON.parse(raw);
      if(data && data.goodThings){
        const card = document.createElement('div');
        card.className = 'history-card';
        card.innerHTML = `<h3>${key}</h3>
          <ul>
            <li>① ${data.goodThings[0]||''}</li>
            <li>② ${data.goodThings[1]||''}</li>
            <li>③ ${data.goodThings[2]||''}</li>
          </ul>
          ${data.comment?`<div class="comment-box">${data.comment}</div>`:''}
          <button onclick="deleteEntry('${key}')">削除</button>`;
        list.appendChild(card);
      } else {
        list.innerHTML = '<p>まだ履歴がありません</p>';
      }
    } catch (err) {
      console.warn('showHistoryModal: skip invalid JSON for key', key, err);
      list.innerHTML = '<p>まだ履歴がありません</p>';
    }
  } else {
    list.innerHTML = '<p>まだ履歴がありません</p>';
  }

  lockBodyScroll();
  modal.classList.add('show');
  requestAnimationFrame(()=>{
    void modal.offsetWidth;
    modal.classList.add('show-animate');
    const content = modal.querySelector('.modal-content');
    if(content) content.scrollTop = 0;
  });
}

function closeModal(e){
  if(!e.target.classList.contains('modal')) return;
  const modal = e.target;
  modal.classList.remove('show-animate');
  setTimeout(()=>{
    modal.classList.remove('show');
    unlockBodyScroll();
  }, 360);
}
function prevDay(){ modalDate.setDate(modalDate.getDate()-1); showHistoryModal(modalDate); }
function nextDay(){ modalDate.setDate(modalDate.getDate()+1); showHistoryModal(modalDate); }
document.getElementById('prevDayBtn').onclick = prevDay;
document.getElementById('nextDayBtn').onclick = nextDay;

/* ---------- 全履歴（iOS で落ちないようにフィルタ＆ try/catch） ---------- */
function showAllHistory(){
  isShowingAllHistory = true;
  const modal = document.getElementById('historyModal');
  const list = document.getElementById('historyList');
  const title = document.getElementById('modalDateTitle');
  list.innerHTML = '';
  title.textContent = '📖 すべての履歴';
  document.getElementById('modalNav').style.display = 'none';

  // 日付キーのみ（YYYY-MM-DD）にフィルタして列挙 — これで SW などで入れた別キーを無視
  const keys = Object.keys(localStorage).filter(k=>/^\d{4}-\d{2}-\d{2}$/.test(k)).sort().reverse();

  if(keys.length === 0){
    list.innerHTML = '<p>まだ履歴がありません</p>';
  } else {
    keys.forEach(k=>{
      const raw = localStorage.getItem(k);
      if(!raw) return;
      try {
        const d = JSON.parse(raw);
        if(!d || !d.goodThings) return;
        const card = document.createElement('div');
        card.className = 'history-card';
        card.innerHTML = `<h3>${k}</h3>
          <ul>
            <li>① ${d.goodThings[0]||''}</li>
            <li>② ${d.goodThings[1]||''}</li>
            <li>③ ${d.goodThings[2]||''}</li>
          </ul>
          ${d.comment?`<div class="comment-box">${d.comment}</div>`:''}
          <button onclick="deleteEntry('${k}')">削除</button>`;
        list.appendChild(card);
      } catch(err){
        console.warn('showAllHistory: skip invalid JSON for key', k, err);
      }
    });
  }

  lockBodyScroll();
  modal.classList.add('show');
  requestAnimationFrame(()=>{ void modal.offsetWidth; modal.classList.add('show-animate'); });
  const content = modal.querySelector('.modal-content');
  if(content) content.scrollTop = 0;
}

/* ---------- 削除 ---------- */
function deleteEntry(key){
  if(!confirm('この記録を削除してもよろしいですか?')) return;
  localStorage.removeItem(key);
  renderCalendar();
  if(isShowingAllHistory) showAllHistory();
  else showHistoryModal(modalDate);
}

/* ---------- 桜 ---------- */
function createSakura(){
  for(let i=0;i<12;i++){
    const s = document.createElement('div');
    s.className = 'sakura';
    s.textContent = '🌸';
    s.style.left = (Math.random()*88 + 6) + '%';
    s.style.fontSize = (14 + Math.random()*28) + 'px';
    s.style.animationDuration = (2 + Math.random()*1.2) + 's';
    document.body.appendChild(s);
    setTimeout(()=> s.remove(), 3200);
  }
}

/* ---------- Service Worker 登録（キャッシュバスト付き） ---------- */
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=> {
    const swUrl = './sw.js?v=' + Date.now();
    navigator.serviceWorker.register(swUrl)
      .then(reg => console.log('SW registered', reg))
      .catch(err => console.warn('SW registration failed', err));
  });
}

/* ---------- 初期化 ---------- */
window.onload = ()=>{
  document.getElementById('entryDateInput').value = formatDate(new Date());
  renderCalendar();

  // Esc でモーダル閉じる
  window.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape'){
      const modal = document.getElementById('historyModal');
      if(modal.classList.contains('show')){
        modal.classList.remove('show-animate');
        setTimeout(()=>{ modal.classList.remove('show'); unlockBodyScroll(); }, 360);
      }
    }
  });
};
</script>
</body>
</html>
